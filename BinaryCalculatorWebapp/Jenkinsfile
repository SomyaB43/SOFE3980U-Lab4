// pipeline {
//     agent any
//     environment {
//         // Filled-in environment variables as per your details
//         GCP_CREDENTIALS_ID = '82740044-f5e9-4f3c-a093-c1e6eff0b7c6'
//         GKE_PROJECT_ID = 'sofe3980-lab3'
//         GKE_CLUSTER_NAME = 'sofe3980u'
//         GKE_CLUSTER_ZONE = 'northamerica-northeast1-b'
//     }
//     tools {
//         // Define any tools needed. Example: Maven
//         maven 'maven'
//     }
//     stages {
//         stage ('Init') {
//             steps {
//                 echo "Start of the pipeline"
//                 sh 'ls -la'
//             }
//         }
//         stage ('Test') {
//             steps {
//                 // Example test command for a Maven project
//                 sh 'mvn clean test -f ./BinaryCalculatorWebapp/pom.xml'
//             }
//         }
//         stage ('Build') {
//             steps {
//                 // Example build command for a Maven project
//                 sh 'mvn package -DskipTests -f ./BinaryCalculatorWebapp/pom.xml'
//             }
//         }
//         // stage ('Deploy to GKE') {
//         //     steps {
//         //         script {
//         //             // Deployment step using the GKE Plugin
//         //             step([
//         //                 $class: 'KubernetesEngineBuilder',
//         //                 credentialsId: GCP_CREDENTIALS_ID,
//         //                 projectId: GKE_PROJECT_ID,
//         //                 clusterName: GKE_CLUSTER_NAME,
//         //                 location: GKE_CLUSTER_ZONE,
//         //                 manifestPattern: 'deployment.yaml', // Path to your Kubernetes manifest
//         //                 namespace: 'default', // Specify your Kubernetes namespace if different from 'default'
//         //                 verifyDeployments: true // Verify the deployment status after applying the manifest
//         //             ])
//         //         }
//         //     }
//         // }
//         stage('Check gcloud and kubectl') {
//             steps {
//                 // Check gcloud version
//                 script {
//                     try {
//                         sh 'gcloud --version'
//                     } catch(Exception e) {
//                         echo "gcloud is not installed or not found in PATH"
//                     }
//                 }
                
//                 // Check kubectl version
//                 script {
//                     try {
//                         sh 'kubectl version --client'
//                     } catch(Exception e) {
//                         echo "kubectl is not installed or not found in PATH"
//                     }
//                 }
//             }
//         }
//     }
// }

pipeline {
  environment {
    PROJECT = "sofe3980-lab3"
    APP_NAME = "binarycalculator"
    CLUSTER = "sofe3980u"
    CLUSTER_ZONE = "northamerica-northeast1-b"
    IMAGE_TAG = "gcr.io/${PROJECT}/${APP_NAME}"
    JENKINS_CRED = "82740044-f5e9-4f3c-a093-c1e6eff0b7c6"

	GCP_CREDENTIALS_ID = '82740044-f5e9-4f3c-a093-c1e6eff0b7c6'
        GKE_PROJECT_ID = 'sofe3980-lab3'
        GKE_CLUSTER_NAME = 'sofe3980u'
        GKE_CLUSTER_ZONE = 'northamerica-northeast1-b'
  }
  
agent {
    kubernetes {
        label 'sample-app'
          defaultContainer 'jnlp'
          yaml """
    apiVersion: v1
    kind: Pod
    metadata:
    labels:
      component: ci
    spec:
      # Use service account that can deploy to all namespaces
      serviceAccountName: cd-jenkins
      containers:
      - name: gcloud
        image: gcr.io/cloud-builders/gcloud
        //image: google/cloud-sdk:latest
        command:
        - cat
        tty: true
      - name: kubectl
        image: gcr.io/cloud-builders/kubectl
        command:
        - cat
        tty: true
    """
    }
 }
  tools {
    maven 'maven' 
  }
  stages {
    stage ('Init') {
      steps {
	    checkout scm
        sh 'echo "Start of Job"'
      }
    }
    //stage ('test') {
    //  steps {
    //    sh 'mvn clean test -f ./BinaryCalculatorWebapp/pom.xml'
    //  }
    //}
    stage ('build') {
      steps {
        sh 'mvn package -DskipTests -f ./BinaryCalculatorWebapp/pom.xml'
      }
    }
    // stage('Build and push image with Container Builder') {
    //   steps {
    //     container('gcloud') {
    //       sh "/builder/google-cloud-sdk/bin/gcloud builds submit -t ${IMAGE_TAG} ./BinaryCalculatorWebapp/"
    //     }
    //   }
    // }
	stage('Build and push image with Container Builder') {
	    steps {
	        withCredentials([file(credentialsId: env.JENKINS_CRED, variable: 'GOOGLE_APPLICATION_CREDENTIALS')]) {
	            container('gcloud') {
	                // Set up gcloud auth using the service account key file from Jenkins credentials
	                sh "/builder/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file=${GOOGLE_APPLICATION_CREDENTIALS}"
	                // Submit the build to Google Cloud Build
	                sh "/builder/google-cloud-sdk/bin/gcloud builds submit -t ${IMAGE_TAG} ./BinaryCalculatorWebapp/"
	            }
	        }
	    }
	}


 //    stage ('Deploy to GKE') {
	// steps {
	// script {
	//     // Deployment step using the GKE Plugin
	//     step([
	// 	$class: 'KubernetesEngineBuilder',
	// 	credentialsId: GCP_CREDENTIALS_ID,
	// 	projectId: GKE_PROJECT_ID,
	// 	clusterName: GKE_CLUSTER_NAME,
	// 	location: GKE_CLUSTER_ZONE,
	// 	manifestPattern: 'deployment.yaml', // Path to your Kubernetes manifest
	// 	namespace: 'default', // Specify your Kubernetes namespace if different from 'default'
	// 	verifyDeployments: true // Verify the deployment status after applying the manifest
	//     ])
	// }
 //      }
 //    }
  }
}
